<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IP Diagnostics Toolkit — HTML Version</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#10b981; --danger:#ef4444;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,var(--bg),#071026);color:#e6eef6}
    .wrap{max-width:1100px;margin:24px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type=text]{background:var(--card);border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:8px;color:inherit;min-width:260px}
    button{background:var(--accent);border:none;padding:9px 12px;border-radius:8px;color:#042018;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .section-title{font-size:13px;color:var(--muted);margin-bottom:8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{display:flex;gap:8px;align-items:flex-start;padding:6px 0}
    .fkey{min-width:140px;color:var(--muted);font-size:13px}
    .fval{font-weight:600;font-size:13px;word-break:break-word}
    pre.raw{background:#010417;padding:10px;border-radius:8px;overflow:auto;color:#cfe8ff;font-size:12px}
    .small{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
    iframe.map{width:100%;height:260px;border:0;border-radius:8px}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .list{margin:0;padding:0;list-style:none}
    .list li{padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px}
    .danger{color:var(--danger)}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    .badge{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:12px}
    @media(max-width:880px){.grid{grid-template-columns:1fr;}.controls{flex-direction:column;align-items:stretch} input[type=text]{width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>IP Diagnostics Toolkit (HTML)</h1>
        <p class="lead">ipwho.is + WebRTC + DoH + Evercookie-style tests + port checks — ব্রাউজার-ভিত্তিক best-effort সংস্করণ।</p>
      </div>
      <div class="controls">
        <input id="ipInput" type="text" placeholder="Enter IP (e.g. 67.101.5.230) or leave blank for your IP" />
        <button id="lookupBtn">Lookup</button>
        <button id="myIpBtn" class="ghost">My IP</button>
      </div>
    </header>

    <div class="grid">
      <div>
        <section class="card" id="overviewCard">
          <div class="section-title">Overview</div>
          <div id="status" class="small">No lookup yet.</div>

          <div id="ipDetails" style="margin-top:12px;display:none">
            <div class="row">
              <div style="flex:1">
                <div class="section-title">IP & Network</div>
                <div class="field"><div class="fkey">IP</div><div class="fval" id="ipVal">—</div></div>
                <div class="field"><div class="fkey">Hostname</div><div class="fval" id="hostnameVal">—</div></div>
                <div class="field"><div class="fkey">ISP / Org</div><div class="fval" id="ispVal">—</div></div>
                <div class="field"><div class="fkey">AS Number</div><div class="fval" id="asnVal">—</div></div>
                <div class="field"><div class="fkey">IP Range</div><div class="fval" id="rangeVal">—</div></div>
              </div>

              <div style="width:320px">
                <div class="section-title">Location & Time</div>
                <div class="field"><div class="fkey">Country / ISO</div><div class="fval" id="countryVal">—</div></div>
                <div class="field"><div class="fkey">Region / City</div><div class="fval" id="regionVal">—</div></div>
                <div class="field"><div class="fkey">ZIP</div><div class="fval" id="zipVal">—</div></div>
                <div class="field"><div class="fkey">Lat / Lon</div><div class="fval" id="latlonVal">—</div></div>
                <div class="field"><div class="fkey">Timezone</div><div class="fval" id="tzVal">—</div></div>
                <div class="field"><div class="fkey">Local system time</div><div class="fval" id="sysTime">—</div></div>
              </div>
            </div>

            <div style="margin-top:12px" class="section-title">Map preview</div>
            <div id="mapWrap"><div class="small">Map will appear after lookup if lat/lon available.</div></div>

            <div style="margin-top:12px" class="section-title">Raw JSON</div>
            <pre id="rawJson" class="raw" style="display:none"></pre>
          </div>
        </section>

        <section class="card" style="margin-top:12px">
          <div class="section-title">Interactive Tests</div>
          <div class="tools" style="margin:8px 0 10px 0">
            <button id="webrtcBtn" class="ghost">Run WebRTC Leak Test</button>
            <button id="dnsBtn" class="ghost">Run DNS Leak (DoH) Test</button>
            <button id="storageBtn" class="ghost">Run Evercookie-style Test</button>
            <button id="portBtn" class="ghost">Quick Port Scan</button>
            <button id="rawBtn" class="ghost">Toggle Raw JSON</button>
          </div>

          <div style="margin-top:8px">
            <div class="section-title">WebRTC Leak</div>
            <div id="webrtcResult" class="small">Not run yet.</div>

            <div style="margin-top:10px" class="section-title">DNS (DoH) results</div>
            <ul id="dnsResults" class="list small"><li>No test yet.</li></ul>

            <div style="margin-top:10px" class="section-title">Storage / Evercookie</div>
            <ul id="storageResults" class="list small"><li>Not run yet.</li></ul>

            <div style="margin-top:10px" class="section-title">Port scan (best-effort)</div>
            <div id="portResults" class="small">Not run yet. (Note: browser has severe limits; results are best-effort)</div>
          </div>
        </section>

        <section class="card" style="margin-top:12px">
          <div class="section-title">Browser Fingerprint & Navigator</div>
          <div class="field"><div class="fkey">User Agent</div><div class="fval" id="uaVal"></div></div>
          <div class="field"><div class="fkey">Platform</div><div class="fval" id="platformVal"></div></div>
          <div class="field"><div class="fkey">Language(s)</div><div class="fval" id="langVal"></div></div>
          <div class="field"><div class="fkey">Cookies enabled</div><div class="fval" id="cookieVal"></div></div>
          <div class="field"><div class="fkey">Do Not Track</div><div class="fval" id="dntVal"></div></div>
          <div class="field"><div class="fkey">hardwareConcurrency</div><div class="fval" id="hcVal"></div></div>
          <div class="field"><div class="fkey">deviceMemory</div><div class="fval" id="dmVal"></div></div>
          <div class="field"><div class="fkey">Plugins (first)</div><div class="fval" id="pluginsVal"></div></div>
        </section>
      </div>

      <aside>
        <div class="card">
          <div class="section-title">Quick Summary</div>
          <div id="quickSummary" class="small">No data</div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="section-title">Diagnostics Snapshot</div>
          <div class="field"><div class="fkey">Screen</div><div class="fval" id="screenVal"></div></div>
          <div class="field"><div class="fkey">Timezone (browser)</div><div class="fval" id="browserTZ"></div></div>
          <div class="field"><div class="fkey">System time (local)</div><div class="fval" id="localTime"></div></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="section-title">Notes & Limitations</div>
          <ul class="list small">
            <li>Browser-based tests are **best-effort**; extensions/VPNs change results.</li>
            <li>True port scanning / WHOIS depth needs server-side tools.</li>
            <li>DNS/DoH checks use public DoH endpoints (Google, Cloudflare).</li>
          </ul>
        </div>
      </aside>
    </div>

    <footer>Built with ❤️ using <span class="badge">ipwho.is</span> • For extended WHOIS/RDAP or server-side port scanning, I can add a backend integration.</footer>
  </div>

<script>
/* ---------- helpers ---------- */
const el = id => document.getElementById(id);
const setText = (id, txt) => { const e = el(id); if(e) e.textContent = (txt ?? '—'); };

/* ---------- init navigator snapshot ---------- */
function snapNavigator() {
  setText('uaVal', navigator.userAgent || '—');
  setText('platformVal', navigator.platform || '—');
  setText('langVal', (navigator.languages && navigator.languages.join(', ')) || navigator.language || '—');
  setText('cookieVal', navigator.cookieEnabled ? 'Yes' : 'No');
  setText('dntVal', navigator.doNotTrack || '—');
  setText('hcVal', navigator.hardwareConcurrency || '—');
  setText('dmVal', navigator.deviceMemory || '—');
  try {
    const p = navigator.plugins ? Array.from(navigator.plugins).slice(0,6).map(x=>x.name).join(', ') : '—';
    setText('pluginsVal', p);
  } catch(e) { setText('pluginsVal', '—'); }
  setText('screenVal', `${screen.width} x ${screen.height} (avail ${screen.availWidth} x ${screen.availHeight})`);
  setText('browserTZ', Intl.DateTimeFormat().resolvedOptions().timeZone || '(unknown)');
  setText('localTime', new Date().toString());
}
snapNavigator();

/* ---------- fetch ipwho.is ---------- */
async function lookupIP(ip='') {
  el('status').textContent = 'Fetching ipwho.is ...';
  try {
    const url = ip ? `https://ipwho.is/${encodeURIComponent(ip)}` : 'https://ipwho.is/';
    const r = await fetch(url);
    const json = await r.json();
    if(!json || json.success===false) {
      el('status').textContent = 'ipwho.is: '+(json && json.message ? json.message : 'No data');
      return;
    }
    el('status').textContent = 'Lookup successful';
    el('ipDetails').style.display = 'block';
    setText('ipVal', json.ip || '—');
    setText('hostnameVal', json.hostname || '—');
    setText('ispVal', (json.connection && json.connection.isp) || json.org || json.isp || '—');
    setText('asnVal', json.asn || (json.connection && json.connection.asn) || '—');
    // ipwho.is sometimes gives range field or not; if not, we show placeholder
    setText('rangeVal', json.range || '—');
    setText('countryVal', `${json.country || '—'} (${json.country_code || ''})`);
    setText('regionVal', `${json.region || '—'}, ${json.city || '—'}`);
    setText('zipVal', json.postal || '—');
    setText('latlonVal', (json.latitude && json.longitude) ? `${json.latitude} / ${json.longitude}` : '—');
    setText('tzVal', (json.timezone && json.timezone.id) ? `${json.timezone.id} (${json.timezone.utc || ''})` : '—');
    setText('sysTime', new Date().toString());
    // Quick summary
    el('quickSummary').innerHTML = `<div class="pill">${json.ip} — ${json.country || '—'} — ${json.connection?.isp || json.isp || '—'}</div>`;
    // Raw JSON
    el('rawJson').textContent = JSON.stringify(json, null, 2);
    el('rawJson').style.display = 'none';
    // map
    if(json.latitude && json.longitude) {
      const lat = json.latitude, lon = json.longitude;
      el('mapWrap').innerHTML = '<iframe class="map" src="https://www.openstreetmap.org/export/embed.html?bbox='
        + (lon-0.05) + '%2C' + (lat-0.03) + '%2C' + (lon+0.05) + '%2C' + (lat+0.03) + '&layer=mapnik&marker=' + lat + '%2C' + lon + '"></iframe>';
    } else {
      el('mapWrap').innerHTML = '<div class="small">No coordinates available to render map.</div>';
    }
  } catch (e) {
    el('status').textContent = 'Lookup failed: ' + e;
  }
}

/* ---------- WebRTC leak test ---------- */
async function runWebRTC() {
  const out = el('webrtcResult');
  out.textContent = 'Running WebRTC... (gathering ICE candidates)';
  const ips = new Set();
  try {
    // cross-browser compatible
    const RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    if(!RTCPeerConnection) {
      out.innerHTML = '<span class="danger">WebRTC not supported in this browser.</span>';
      return;
    }
    const pc = new RTCPeerConnection({iceServers:[]});
    pc.createDataChannel('');
    pc.onicecandidate = (evt) => {
      if(!evt || !evt.candidate) return;
      const s = evt.candidate.candidate || '';
      const m = s.match(/([0-9]{1,3}(?:\\.[0-9]{1,3}){3})/g);
      if(m) m.forEach(ip=>ips.add(ip));
      out.textContent = 'Detected IP(s): ' + Array.from(ips).join(', ');
    };
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    // wait a bit
    setTimeout(()=>{ try{ pc.close(); }catch(e){}; if(ips.size===0) out.textContent='No IPs detected (or blocked by browser/VPN/extensions)'; }, 2500);
  } catch(e) {
    out.innerHTML = '<span class="danger">Error running WebRTC test: '+e+'</span>';
  }
}

/* ---------- DNS (DoH) test ---------- */
async function runDoH() {
  const list = el('dnsResults');
  list.innerHTML = '<li class="small">Running DNS-over-HTTPS queries...</li>';
  const endpoints = [
    {name:'Google DoH', url:'https://dns.google/resolve?name=example.com&type=A'},
    {name:'Cloudflare DoH', url:'https://cloudflare-dns.com/dns-query?name=example.com&type=A'}
  ];
  const results = [];
  for(const ep of endpoints){
    try{
      const r = await fetch(ep.url, {headers:{'Accept':'application/dns-json'}}); // CORS: these endpoints allow
      const j = await r.json();
      const ans = (j.Answer && j.Answer.length) ? j.Answer.map(a=>a.data).slice(0,4).join(', ') : '(no answers)';
      results.push(`<li><strong>${ep.name}</strong>: ${ans}</li>`);
    } catch(e) {
      results.push(`<li class="danger"><strong>${ep.name}</strong>: failed (${e})</li>`);
    }
  }
  list.innerHTML = results.join('');
}

/* ---------- Evercookie-style storage test ---------- */
async function runStorageTests(){
  const ul = el('storageResults');
  ul.innerHTML = '<li>Running tests...</li>';
  const out = [];
  // cookie
  try{ document.cookie = 'echk=1; max-age=31536000; path=/'; out.push(`<li>Cookie: ${document.cookie.includes('echk=1')?'Present':'Missing'}</li>`); } catch(e){ out.push(`<li>Cookie: error</li>`); }
  // localStorage
  try{ localStorage.setItem('echk','1'); out.push(`<li>localStorage: ${localStorage.getItem('echk')==='1'?'Present':'Missing'}</li>`); }catch(e){ out.push(`<li>localStorage: blocked</li>`); }
  // sessionStorage
  try{ sessionStorage.setItem('echk','1'); out.push(`<li>sessionStorage: ${sessionStorage.getItem('echk')==='1'?'Present':'Missing'}</li>`); }catch(e){ out.push(`<li>sessionStorage: blocked</li>`); }
  // indexedDB
  try{
    const req = indexedDB.open('echk_db',1);
    req.onupgradeneeded = e => { const db = e.target.result; if(!db.objectStoreNames.contains('s')) db.createObjectStore('s'); };
    req.onsuccess = e => {
      const db = e.target.result;
      const tx = db.transaction('s','readwrite'); const s = tx.objectStore('s'); s.put('1','echk');
      tx.oncomplete = ()=>{
        const tx2 = db.transaction('s','readonly'); const s2 = tx2.objectStore('s'); const get = s2.get('echk');
        get.onsuccess = ()=>{ out.push(`<li>indexedDB: ${(get.result==='1')?'Present':'Missing'}</li>`); ul.innerHTML = out.join(''); db.close(); };
      };
    };
    req.onerror = ()=>{ out.push(`<li>indexedDB: error/blocked</li>`); ul.innerHTML = out.join(''); };
  }catch(e){ out.push(`<li>indexedDB: error</li>`); ul.innerHTML = out.join(''); }
  // caches
  try{ if('caches' in window){ await caches.open('echk_cache').then(c=>c.put('/echk.txt', new Response('1'))); out.push(`<li>CacheStorage: present (local)</li>`);} else out.push(`<li>CacheStorage: not supported</li>`);}catch(e){ out.push(`<li>CacheStorage: blocked/error</li>`); }
  // WebSQL try (deprecated)
  try{ if(window.openDatabase){ const db = openDatabase('echk','1.0','echk',2*1024*1024); db.transaction(tx=>{ tx.executeSql('CREATE TABLE IF NOT EXISTS s (k text, v text)'); tx.executeSql('INSERT INTO s (k,v) VALUES (?,?)',['echk','1']); tx.executeSql('SELECT v FROM s WHERE k=?',['echk'], (t,r)=>{ out.push(`<li>WebSQL: ${r.rows.length>0?'Present':'Missing'}</li>`); ul.innerHTML = out.join(''); }); }); } else { out.push(`<li>WebSQL: not supported</li>`); } }catch(e){ out.push(`<li>WebSQL: error</li>`); }
  // update ui
  ul.innerHTML = out.join('') + (ul.innerHTML?'':'<li>Checking indexedDB...</li>');
}

/* ---------- Port scan (very limited) ---------- */
async function tryPort(ip, port, timeout=3000) {
  // Try loading favicon over https then http using Image.onload/onerror
  return new Promise(resolve=>{
    const protocols = ['https','http'];
    let i = 0, done=false;
    const tryProto = (p)=>{
      const img = new Image();
      const url = `${p}://${ip}:${port}/favicon.ico`;
      const t = setTimeout(()=>{ if(!done){ done=true; resolve({port, state:'timeout/filtered'}); } }, timeout);
      img.onload = ()=>{ if(!done){ done=true; clearTimeout(t); resolve({port, state:'open (image loaded)', proto:p}); } };
      img.onerror = ()=>{ i++; clearTimeout(t); if(i>=protocols.length && !done){ done=true; resolve({port, state:'closed/filtered'}); } else if(!done) tryProto(protocols[i]); };
      try{ img.src = url + '?_='+Date.now(); } catch(e){ if(!done){ done=true; resolve({port, state:'error'}); } }
    };
    tryProto(protocols[i]);
  });
}

async function runPortScan(){
  const txt = el('portResults');
  const ip = el('ipInput').value.trim() || (el('ipVal') && el('ipVal').textContent!=='—' ? el('ipVal').textContent : null);
  if(!ip){ txt.textContent = 'No target IP known. Run Lookup or provide IP.'; return; }
  txt.textContent = 'Scanning common ports (80,443,8080,8443,22,21,3389) — this is very limited...';
  const ports = [80,443,8080,8443,22,21,3389];
  const results = [];
  for(const p of ports){
    const r = await tryPort(ip,p,2500);
    results.push(r);
    txt.innerHTML = results.map(rr=>`Port ${rr.port}: ${rr.state}${rr.proto? ' ('+rr.proto+')':''}`).join('<br>');
  }
}

/* ---------- wire UI ---------- */
el('lookupBtn').addEventListener('click', ()=> lookupIP(el('ipInput').value.trim()));
el('myIpBtn').addEventListener('click', ()=> { el('ipInput').value=''; lookupIP(); });
el('webrtcBtn').addEventListener('click', runWebRTC);
el('dnsBtn').addEventListener('click', runDoH);
el('storageBtn').addEventListener('click', runStorageTests);
el('portBtn').addEventListener('click', runPortScan);
el('rawBtn').addEventListener('click', ()=>{
  const r = el('rawJson'); r.style.display = (r.style.display==='none' || r.style.display==='') ? 'block' : 'none';
});

/* show quick initial */
setText('status','Ready — press Lookup or My IP.');

/* optional: auto-run lookup on load (uncomment if you want) */
// lookupIP();
</script>
</body>
</html>
